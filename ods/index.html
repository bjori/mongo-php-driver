<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

        <title>Object Document Serialization - PHongo: The MongoDB Driver for PHP</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">PHongo: The MongoDB Driver for PHP</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CRUD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../crud">Basic</a>
                        </li>
                    
                        <li >
                            <a href="../batch">Batches</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../commands">Commands</a>
                </li>
            
            
            
                <li class="active">
                    <a href=".">Object Document Serialization</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../commands">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/10gen-labs/mongo-php-driver-prototype">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#object-serialization">Object serialization</a></li>
        
            <li><a href="#examples">Examples</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="object-serialization">Object serialization</h1>
<p>PHongo exports 4 public interfaces to facilitate serializing PHP classes to and from BSON.</p>
<ul>
<li>BSON\Type<ul>
<li>(no methods)</li>
</ul>
</li>
<li>BSON\Serializable<ul>
<li>abstract public method bsonSerialize();</li>
</ul>
</li>
<li>BSON\Unserializable<ul>
<li>abstract public method bsonUnserialize(array $data);</li>
</ul>
</li>
<li>BSON\Persistable<ul>
<li>implements both BSON\Serializable and BSON\Unserializable</li>
</ul>
</li>
</ul>
<p>Objects that implement the BSON\Type interface get very special treatment by the BSON serializer. In
general, these objects represent a BSON type that cannot be natively represented in PHP - such as
BSON\UTCDatetime and BSON\ObjectID - and are specifically checked for and handled.
Note that implmenting BSON\Type and or BSON\Unserializable standalone does not do anything for
userland classes.</p>
<p>Since BSON\Type is a public interface, normal userland classes can indeed implement it to, and apply
their own custom rules on the serialization.
To achieve this though, the BSON\Serializable interface should be implemented instead, providing the
bsonSerialize() function which should return a PHP array() representing the document that should be
stored.
Furthermore, if the object implements the BSON\Persistable interface, the driver will embed a BSON
Binary (0x80) with the fully qualified classname, into the document.</p>
<p>During unserialization of a document, if a BSON Binary (of type 0x80) is encountered, the driver
will peak at the value and attempt to resolve it to a classname (triggering autoloaders if
neccesary). If the classname cannot be resolved, no harm no faul, and nothing magical happens.
However, if the class exists, the driver will call the bsonUnserialize() method of the detected
class, passing it the full document.
Note that this happens depth-first, meaning any subdocuments (relations) are resolved first, and
then crawled upwards to the start of the document.</p>
<h2 id="examples">Examples</h2>
<p>Imagine the following two classes, Person and Address.</p>
<p>A Person has name, age, friends (Person), and addresses (Address).
A Person also has a secret, that we would rather not store in a database.</p>
<pre><code>&lt;?php
class Person implements BSON\Persistable {
    protected $_id;
    protected $name;
    protected $age;
    protected $address = array();
    protected $friends = array();
    protected $secret = &quot;none&quot;;

    function __construct($name, $age) {
        $this-&gt;name    = $name;
        $this-&gt;age     = $age;
        $this-&gt;address = array();
        $this-&gt;secret  = &quot;$name confidential info&quot;;
        /* Pregenerate our ObjectID */
        $this-&gt;_id     = new BSON\ObjectID();
    }
    function addAddress(Address $address) {
        $this-&gt;address[] = $address;
    }
    function addFriend(Person $friend) {
        $this-&gt;friends[] = $friend;
    }
    function bsonSerialize() {
        return array(
            &quot;_id&quot;     =&gt; $this-&gt;_id,
            &quot;name&quot;    =&gt; $this-&gt;name,
            &quot;age&quot;     =&gt; $this-&gt;age,
            &quot;address&quot; =&gt; $this-&gt;address,
            &quot;friends&quot; =&gt; $this-&gt;friends,
        );
    }
    function bsonUnserialize(array $data) {
        $this-&gt;_id     = $data[&quot;_id&quot;];
        $this-&gt;name    = $data[&quot;name&quot;];
        $this-&gt;age     = $data[&quot;age&quot;];
        $this-&gt;address = $data[&quot;address&quot;];
        $this-&gt;friends = $data[&quot;friends&quot;];
    }
}

class Address implements BSON\Persistable {
    protected $zip;
    protected $country;

    function __construct($zip, $country) {
        $this-&gt;zip = $zip;
        $this-&gt;country = $country;
    }
    function bsonSerialize() {
        return array(
            &quot;zip&quot;     =&gt; $this-&gt;zip,
            &quot;country&quot; =&gt; $this-&gt;country,
        );
    }
    function bsonUnserialize(array $data) {
        $this-&gt;zip = $data[&quot;zip&quot;];
        $this-&gt;country = $data[&quot;country&quot;];
    }
}
?&gt;
</code></pre>

<p>Hannes, 31 years old, has two addresses;</p>
<ul>
<li>Sunnyvale, USA</li>
<li>Kopavogur, Iceland</li>
</ul>
<p>He is friends with young Jeremy, 21 year old who lives in Michigan</p>
<pre><code>&lt;?php
$hannes = new Person(&quot;Hannes&quot;, 31);
$sunnyvale = new Address(94086, &quot;USA&quot;);
$kopavogur = new Address(200, &quot;Iceland&quot;);
$hannes-&gt;addAddress($sunnyvale);
$hannes-&gt;addAddress($kopavogur);

$mikola = new Person(&quot;Jeremy&quot;, 21);
$michigan = new Address(48169, &quot;USA&quot;);
$mikola-&gt;addAddress($michigan);

$hannes-&gt;addFriend($mikola);
?&gt;
</code></pre>

<p>To save this information we can insert $hannes to the database like so:</p>
<pre><code>&lt;?php
try {
    $wc = new MongoDB\Driver\WriteConcern(MongoDB\Driver\WriteConcern::MAJORITY);
    $manager = new MongoDB\Driver\Manager(&quot;mongodb://192.168.112.10:2000&quot;);
    $result = $manager-&gt;executeInsert(&quot;congress.people&quot;, $hannes, $wc);
    echo &quot;Hannes has been inserted\n&quot;;
} catch(Exception $e) {
    echo $e-&gt;getMessage(), &quot;\n&quot;;
    exit;
}
?&gt;
</code></pre>

<p>This will result in the following document to be stored (as shown by mongo shell):</p>
<pre><code>{
        &quot;_id&quot; : ObjectId(&quot;54c9664fbd21b9416f2e0501&quot;),
        &quot;__&quot; : BinData(128,&quot;UGVyc29u&quot;),
        &quot;name&quot; : &quot;Hannes&quot;,
        &quot;age&quot; : 31,
        &quot;address&quot; : [
                [
                        BinData(128,&quot;QWRkcmVzcw==&quot;),
                        94086,
                        &quot;USA&quot;
                ],
                [
                        BinData(128,&quot;QWRkcmVzcw==&quot;),
                        200,
                        &quot;Iceland&quot;
                ]
        ],
        &quot;friends&quot; : [
                [
                        BinData(128,&quot;UGVyc29u&quot;),
                        ObjectId(&quot;54c9664fbd21b9416f2e0502&quot;),
                        &quot;Jeremy&quot;,
                        21,
                        [
                                [
                                        BinData(128,&quot;QWRkcmVzcw==&quot;),
                                        48169,
                                        &quot;USA&quot;
                                ]
                        ],
                        {

                        }
                ]
        ]
}
</code></pre>

<p>When we read this document back, the driver will convert the individual subdocuments back into the
original classes, as we have full type information for them now:</p>
<pre><code>&lt;?php
$rp = new MongoDB\Driver\ReadPreference(MongoDB\Driver\ReadPreference::RP_PRIMARY_PREFERRED);
$query = new MongoDB\Driver\Query(array());
$cursor = $manager-&gt;executeQuery(&quot;congress.people&quot;, $query, $rp);
foreach($cursor as $person) {
    var_dump($person);
}
?&gt;
</code></pre>

<p>Which results in:</p>
<pre><code>object(Person)#22 (6) {
  [&quot;_id&quot;:protected]=&gt;
  object(BSON\ObjectID)#15 (0) {
  }
  [&quot;name&quot;:protected]=&gt;
  string(6) &quot;Hannes&quot;
  [&quot;age&quot;:protected]=&gt;
  int(31)
  [&quot;address&quot;:protected]=&gt;
  array(2) {
    [0]=&gt;
    object(Address)#16 (2) {
      [&quot;zip&quot;:protected]=&gt;
      int(94086)
      [&quot;country&quot;:protected]=&gt;
      string(3) &quot;USA&quot;
    }
    [1]=&gt;
    object(Address)#17 (2) {
      [&quot;zip&quot;:protected]=&gt;
      int(200)
      [&quot;country&quot;:protected]=&gt;
      string(7) &quot;Iceland&quot;
    }
  }
  [&quot;friends&quot;:protected]=&gt;
  array(1) {
    [0]=&gt;
    object(Person)#21 (6) {
      [&quot;_id&quot;:protected]=&gt;
      object(BSON\ObjectID)#18 (0) {
      }
      [&quot;name&quot;:protected]=&gt;
      string(6) &quot;Jeremy&quot;
      [&quot;age&quot;:protected]=&gt;
      int(21)
      [&quot;address&quot;:protected]=&gt;
      array(1) {
        [0]=&gt;
        object(Address)#19 (2) {
          [&quot;zip&quot;:protected]=&gt;
          int(48169)
          [&quot;country&quot;:protected]=&gt;
          string(3) &quot;USA&quot;
        }
      }
      [&quot;friends&quot;:protected]=&gt;
      object(stdClass)#20 (0) {
      }
      [&quot;secret&quot;:protected]=&gt;
      string(4) &quot;none&quot;
    }
  }
  [&quot;secret&quot;:protected]=&gt;
  string(4) &quot;none&quot;
}
</code></pre>

</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
        <script src="../pretty.js"></script>
        <script src="../jira.js"></script>
    </body>
</html>